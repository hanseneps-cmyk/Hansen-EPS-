<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suivi d'Activit√© Physique - 2 Ann√©es</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .profile-section {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .profile-row {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .profile-item {
            display: flex;
            flex-direction: column;
            min-width: 200px;
        }

        .profile-item label {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .profile-item input {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .controls {
            padding: 20px;
            background: #fff;
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .form-item {
            display: flex;
            flex-direction: column;
            min-width: 150px;
        }

        .form-item label {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .form-item input, .form-item select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            margin: 5px;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-success { background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%); }
        .btn-danger { background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%); }
        .btn-info { background: linear-gradient(135deg, #36d1dc 0%, #5b86e5 100%); }
        .btn-warning { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }

        .content {
            padding: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            border-left: 5px solid #667eea;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            overflow-x: auto;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 10px;
            text-align: center;
            font-weight: 600;
        }

        td {
            padding: 12px 10px;
            text-align: center;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
        }

        .steps-high {
            background: #4caf50;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
        }

        .steps-low {
            background: #f44336;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
        }

        .activity-yes {
            background: #2196f3;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .location-enterprise {
            background: #ff9800;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .location-training {
            background: #9c27b0;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .alert {
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
            font-weight: 500;
        }

        .alert-success { background: #d4edda; color: #155724; }
        .alert-danger { background: #f8d7da; color: #721c24; }
        .alert-info { background: #d1ecf1; color: #0c5460; }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            border-radius: 8px;
            transition: all 0.3s ease;
            min-width: 120px;
            white-space: nowrap;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .tab:hover:not(.active) {
            background: #e9ecef;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .summary-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
        }

        .summary-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: white;
            margin-bottom: 15px;
            text-align: center;
            padding: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .summary-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            transition: width 0.3s ease;
        }

        .location-stats-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            margin: 20px 0;
        }

        .location-stats-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .comparison-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 12px;
            border-left: 5px solid;
        }

        .comparison-card.enterprise { border-left-color: #ff9800; }
        .comparison-card.training { border-left-color: #9c27b0; }
        .comparison-card.personal { border-left-color: #2196f3; }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Suivi d'Activit√© Physique Complet</h1>
            <p>Tableau de bord sur 2 ann√©es avec bilans d√©taill√©s</p>
        </div>

        <div class="profile-section">
            <div class="profile-row">
                <div class="profile-item">
                    <label>Pr√©nom :</label>
                    <input type="text" id="firstName" placeholder="Votre pr√©nom">
                </div>
                <div class="profile-item">
                    <label>Nom :</label>
                    <input type="text" id="lastName" placeholder="Votre nom">
                </div>
                <div class="profile-item">
                    <label>Date d√©but suivi (2 ans) :</label>
                    <input type="date" id="startDate">
                </div>
                <div>
                    <button class="btn btn-info" id="btnSaveProfile">üíæ Sauvegarder profil</button>
                </div>
            </div>
        </div>

        <div class="controls">
            <div class="form-item">
                <label>Date :</label>
                <input type="date" id="dateInput">
            </div>
            <div class="form-item">
                <label>Nombre de pas :</label>
                <input type="number" id="stepsInput" min="0" placeholder="8500">
            </div>
            <div class="form-item">
                <label>Activit√© physique :</label>
                <select id="activityInput">
                    <option value="">Non</option>
                    <option value="Course">Course</option>
                    <option value="V√©lo">V√©lo</option>
                    <option value="Natation">Natation</option>
                    <option value="Gym">Gym/Fitness</option>
                    <option value="Marche">Marche rapide</option>
                    <option value="Football">Football</option>
                    <option value="Tennis">Tennis</option>
                    <option value="Yoga">Yoga</option>
                    <option value="Autre">Autre</option>
                </select>
            </div>
            <div class="form-item">
                <label>Lieu :</label>
                <select id="locationInput">
                    <option value="">-</option>
                    <option value="Entreprise">Entreprise</option>
                    <option value="Formation">Centre de formation</option>
                    <option value="Personnel">Personnel</option>
                </select>
            </div>
            <div class="button-group">
                <button class="btn btn-success" id="btnAdd">‚úÖ Ajouter</button>
                <button class="btn btn-info" id="btnExportExcel">üìä Export Excel</button>
                <button class="btn btn-warning" id="btnExportCSV">üìã Export CSV</button>
                <button class="btn btn-danger" id="btnClear">üóëÔ∏è Vider</button>
                <button class="btn btn-info" id="btnGenerateQR">üì± G√©n√©rer QR Code</button>
            </div>
        </div>

        <div class="content">
            <div id="messageArea"></div>

            <div class="tabs">
                <div class="tab active" data-tab="overview">üìä Vue d'ensemble</div>
                <div class="tab" data-tab="locations">üìç Stats par lieu</div>
                <div class="tab" data-tab="monthly">üìÖ Bilan mensuel</div>
                <div class="tab" data-tab="yearly">üóìÔ∏è Bilan annuel</div>
                <div class="tab" data-tab="final">üèÜ Bilan 2 ans</div>
                <div class="tab" data-tab="data">üìã Donn√©es</div>
            </div>

            <div class="tab-content active" id="overview">
                <div class="stats-grid" id="overviewStats"></div>
            </div>

            <div class="tab-content" id="locations">
                <h2 style="text-align: center; margin-bottom: 20px; color: #333;">üìç Statistiques d√©taill√©es par lieu</h2>
                <div id="locationStats"></div>
            </div>

            <div class="tab-content" id="monthly">
                <h2 style="text-align: center; margin-bottom: 20px; color: #333;">üìÖ Analyse mensuelle d√©taill√©e</h2>
                <div id="monthlyContent"></div>
            </div>

            <div class="tab-content" id="yearly">
                <h2 style="text-align: center; margin-bottom: 20px; color: #333;">üóìÔ∏è Comparaison annuelle</h2>
                <div id="yearlyContent"></div>
            </div>

            <div class="tab-content" id="final">
                <h2 style="text-align: center; margin-bottom: 20px; color: #333;">üèÜ Bilan complet sur 2 ann√©es</h2>
                <div id="finalContent"></div>
            </div>

            <div class="tab-content" id="data">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Pas</th>
                                <th>Objectif 7000+</th>
                                <th>Activit√©</th>
                                <th>Type</th>
                                <th>Lieu</th>
                                <th>Mois/Ann√©e</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="dataTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de modification -->
    <div id="editModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%;">
            <h2 style="margin-bottom: 20px; color: #333;">Modifier l'entr√©e</h2>
            <div style="margin-bottom: 15px;">
                <label style="font-weight: 600; color: #333; display: block; margin-bottom: 5px;">Date :</label>
                <input type="date" id="editDate" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
            </div>
            <div style="margin-bottom: 15px;">
                <label style="font-weight: 600; color: #333; display: block; margin-bottom: 5px;">Nombre de pas :</label>
                <input type="number" id="editSteps" min="0" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
            </div>
            <div style="margin-bottom: 15px;">
                <label style="font-weight: 600; color: #333; display: block; margin-bottom: 5px;">Activit√© physique :</label>
                <select id="editActivity" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                    <option value="">Non</option>
                    <option value="Course">Course</option>
                    <option value="V√©lo">V√©lo</option>
                    <option value="Natation">Natation</option>
                    <option value="Gym">Gym/Fitness</option>
                    <option value="Marche">Marche rapide</option>
                    <option value="Football">Football</option>
                    <option value="Tennis">Tennis</option>
                    <option value="Yoga">Yoga</option>
                    <option value="Autre">Autre</option>
                </select>
            </div>
            <div style="margin-bottom: 15px;">
                <label style="font-weight: 600; color: #333; display: block; margin-bottom: 5px;">Lieu :</label>
                <select id="editLocation" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                    <option value="">-</option>
                    <option value="Entreprise">Entreprise</option>
                    <option value="Formation">Centre de formation</option>
                    <option value="Personnel">Personnel</option>
                </select>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-success" id="btnSaveEdit" style="flex: 1;">Enregistrer</button>
                <button class="btn btn-danger" id="btnCancelEdit" style="flex: 1;">Annuler</button>
            </div>
        </div>
    </div>

    <!-- Modal QR Code -->
    <div id="qrModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; padding: 30px; border-radius: 15px; max-width: 600px; width: 90%; text-align: center;">
            <h2 style="margin-bottom: 20px; color: #333;">QR Code - T√©l√©chargement de l'application</h2>
            <p style="margin-bottom: 20px; color: #666;">Scannez ce QR code avec votre smartphone pour t√©l√©charger le fichier HTML</p>
            <div id="qrCodeContainer" style="display: flex; justify-content: center; margin: 20px 0;"></div>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 20px 0;">
                <p style="font-size: 0.9rem; color: #666; margin-bottom: 10px;">
                    <strong>Instructions :</strong><br>
                    1. Scannez le QR code avec votre smartphone<br>
                    2. Le fichier HTML se t√©l√©chargera automatiquement<br>
                    3. Ouvrez-le avec n'importe quel navigateur<br>
                    4. Vos donn√©es sont stock√©es localement sur votre appareil
                </p>
            </div>
            <button class="btn btn-info" id="btnCloseQR">Fermer</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <script>
        let activityData = [];
        let userProfile = { firstName: '', lastName: '', startDate: '' };
        let editingDate = null;

        document.addEventListener('DOMContentLoaded', function() {
            loadProfile();
            loadData();
            setTodayDate();
            updateAllDisplays();
            initEventListeners();
        });

        function initEventListeners() {
            document.getElementById('btnSaveProfile').addEventListener('click', saveProfile);
            document.getElementById('btnAdd').addEventListener('click', addEntry);
            document.getElementById('btnExportExcel').addEventListener('click', exportToExcel);
            document.getElementById('btnExportCSV').addEventListener('click', exportToCSV);
            document.getElementById('btnClear').addEventListener('click', clearData);
            document.getElementById('btnGenerateQR').addEventListener('click', generateQRCode);
            document.getElementById('btnSaveEdit').addEventListener('click', saveEdit);
            document.getElementById('btnCancelEdit').addEventListener('click', closeEditModal);
            document.getElementById('btnCloseQR').addEventListener('click', closeQRModal);

            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    switchToTab(this.getAttribute('data-tab'));
                });
            });
        }

        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateInput').value = today;
        }

        function loadProfile() {
            const saved = localStorage.getItem('userProfile');
            if (saved) {
                userProfile = JSON.parse(saved);
                document.getElementById('firstName').value = userProfile.firstName || '';
                document.getElementById('lastName').value = userProfile.lastName || '';
                document.getElementById('startDate').value = userProfile.startDate || '';
            }
        }

        function saveProfile() {
            userProfile.firstName = document.getElementById('firstName').value;
            userProfile.lastName = document.getElementById('lastName').value;
            userProfile.startDate = document.getElementById('startDate').value;
            
            localStorage.setItem('userProfile', JSON.stringify(userProfile));
            showMessage('‚úÖ Profil sauvegard√© avec succ√®s !', 'success');
            updateAllDisplays();
        }

        function loadData() {
            const saved = localStorage.getItem('activityData');
            if (saved) {
                activityData = JSON.parse(saved);
            } else {
                activityData = [
                    { date: '2024-01-15', steps: 8500, activity: 'Course', location: 'Entreprise' },
                    { date: '2024-01-16', steps: 4500, activity: '', location: 'Formation' },
                    { date: '2024-01-17', steps: 9200, activity: 'V√©lo', location: 'Personnel' },
                    { date: '2024-02-10', steps: 7800, activity: 'Marche', location: 'Entreprise' },
                    { date: '2024-02-15', steps: 6200, activity: '', location: 'Formation' },
                    { date: '2024-03-05', steps: 10500, activity: 'Course', location: 'Personnel' },
                    { date: '2024-03-12', steps: 5800, activity: 'Gym', location: 'Entreprise' },
                    { date: '2025-01-20', steps: 9800, activity: 'Course', location: 'Personnel' },
                    { date: '2025-02-05', steps: 7200, activity: 'Marche', location: 'Formation' }
                ];
                saveData();
            }
        }

        function saveData() {
            localStorage.setItem('activityData', JSON.stringify(activityData));
        }

        function addEntry() {
            const date = document.getElementById('dateInput').value;
            let steps = parseInt(document.getElementById('stepsInput').value);
            const activity = document.getElementById('activityInput').value;
            const location = document.getElementById('locationInput').value;

            if (!date) {
                showMessage('‚ùå Veuillez s√©lectionner une date', 'danger');
                return;
            }

            // Si une activit√© physique est s√©lectionn√©e, on garantit au minimum 7000 pas
            if (activity && activity !== '') {
                if (isNaN(steps) || steps < 7000) {
                    steps = 7000;
                    showMessage('‚úÖ Activit√© physique d√©tect√©e : objectif 7000 pas automatiquement valid√© !', 'success');
                }
            } else {
                if (isNaN(steps) || steps < 0) {
                    showMessage('‚ùå Veuillez entrer un nombre de pas valide', 'danger');
                    return;
                }
            }

            const existingIndex = activityData.findIndex(entry => entry.date === date);
            const newEntry = { date: date, steps: steps, activity: activity, location: location };

            if (existingIndex >= 0) {
                if (confirm('Une entr√©e existe d√©j√† pour cette date. Voulez-vous la remplacer ?')) {
                    activityData[existingIndex] = newEntry;
                    showMessage('‚úÖ Entr√©e mise √† jour !', 'success');
                } else {
                    return;
                }
            } else {
                activityData.push(newEntry);
                showMessage('‚úÖ Entr√©e ajout√©e !', 'success');
            }

            activityData.sort((a, b) => new Date(a.date) - new Date(b.date));
            saveData();
            updateAllDisplays();

            document.getElementById('stepsInput').value = '';
            document.getElementById('activityInput').value = '';
            document.getElementById('locationInput').value = '';
            setTodayDate();
        }

        function deleteEntry(date) {
            if (confirm('Supprimer cette entr√©e ?')) {
                activityData = activityData.filter(entry => entry.date !== date);
                saveData();
                updateAllDisplays();
                showMessage('üóëÔ∏è Entr√©e supprim√©e', 'info');
            }
        }

        function editEntry(date) {
            const entry = activityData.find(e => e.date === date);
            if (!entry) return;

            editingDate = date;
            document.getElementById('editDate').value = entry.date;
            document.getElementById('editSteps').value = entry.steps;
            document.getElementById('editActivity').value = entry.activity || '';
            document.getElementById('editLocation').value = entry.location || '';
            
            document.getElementById('editModal').style.display = 'flex';
        }

        function saveEdit() {
            const newDate = document.getElementById('editDate').value;
            let newSteps = parseInt(document.getElementById('editSteps').value);
            const newActivity = document.getElementById('editActivity').value;
            const newLocation = document.getElementById('editLocation').value;

            if (!newDate) {
                showMessage('‚ùå Veuillez s√©lectionner une date', 'danger');
                return;
            }

            // Si une activit√© physique est s√©lectionn√©e, on garantit au minimum 7000 pas
            if (newActivity && newActivity !== '') {
                if (isNaN(newSteps) || newSteps < 7000) {
                    newSteps = 7000;
                }
            } else {
                if (isNaN(newSteps) || newSteps < 0) {
                    showMessage('‚ùå Veuillez entrer un nombre de pas valide', 'danger');
                    return;
                }
            }

            // Supprimer l'ancienne entr√©e
            activityData = activityData.filter(entry => entry.date !== editingDate);

            // Ajouter la nouvelle entr√©e
            const newEntry = { date: newDate, steps: newSteps, activity: newActivity, location: newLocation };
            activityData.push(newEntry);
            activityData.sort((a, b) => new Date(a.date) - new Date(b.date));

            saveData();
            updateAllDisplays();
            closeEditModal();
            showMessage('‚úÖ Entr√©e modifi√©e avec succ√®s !', 'success');
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            editingDate = null;
        }

        function generateQRCode() {
            const currentURL = window.location.href;
            
            document.getElementById('qrCodeContainer').innerHTML = '';
            document.getElementById('qrModal').style.display = 'flex';
            
            setTimeout(() => {
                new QRCode(document.getElementById('qrCodeContainer'), {
                    text: currentURL,
                    width: 256,
                    height: 256,
                    colorDark: '#667eea',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.H
                });
            }, 100);
        }

        function closeQRModal() {
            document.getElementById('qrModal').style.display = 'none';
        }

        function clearData() {
            if (confirm('‚ö†Ô∏è Supprimer TOUTES les donn√©es ?')) {
                if (confirm('‚ö†Ô∏è Cette action est irr√©versible. Continuer ?')) {
                    activityData = [];
                    saveData();
                    updateAllDisplays();
                    showMessage('üóëÔ∏è Toutes les donn√©es supprim√©es', 'info');
                }
            }
        }

        function exportToExcel() {
            if (typeof XLSX === 'undefined') {
                showMessage('‚ùå Biblioth√®que Excel non disponible. Utilisez l\'export CSV.', 'danger');
                return;
            }

            if (activityData.length === 0) {
                showMessage('‚ùå Aucune donn√©e √† exporter', 'danger');
                return;
            }

            const excelData = activityData.map(entry => {
                const date = new Date(entry.date);
                const monthYear = date.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
                
                return {
                    'Date': entry.date,
                    'Nombre de pas': entry.steps,
                    'Objectif 7000+ atteint': (entry.steps >= 7000 || entry.activity) ? 'Oui' : 'Non',
                    'Activit√© physique': entry.activity ? 'Oui' : 'Non',
                    'Type activit√©': entry.activity || '',
                    'Lieu': entry.location || '',
                    'Mois/Ann√©e': monthYear
                };
            });

            const wb = XLSX.utils.book_new();
            const ws1 = XLSX.utils.json_to_sheet(excelData);
            XLSX.utils.book_append_sheet(wb, ws1, 'Donn√©es quotidiennes');
            
            const locationStats = calculateLocationStats();
            const statsArray = [
                { Lieu: 'Entreprise', 'Total jours': locationStats.enterprise.total, 'Jours 7000+': locationStats.enterprise.over7000, 'Taux': Math.round((locationStats.enterprise.over7000 / locationStats.enterprise.total) * 100) + '%', 'Moyenne pas': locationStats.enterprise.avgSteps },
                { Lieu: 'Formation', 'Total jours': locationStats.training.total, 'Jours 7000+': locationStats.training.over7000, 'Taux': Math.round((locationStats.training.over7000 / locationStats.training.total) * 100) + '%', 'Moyenne pas': locationStats.training.avgSteps },
                { Lieu: 'Personnel', 'Total jours': locationStats.personal.total, 'Jours 7000+': locationStats.personal.over7000, 'Taux': Math.round((locationStats.personal.over7000 / locationStats.personal.total) * 100) + '%', 'Moyenne pas': locationStats.personal.avgSteps }
            ];
            const ws2 = XLSX.utils.json_to_sheet(statsArray);
            XLSX.utils.book_append_sheet(wb, ws2, 'Stats par lieu');

            const fileName = `Suivi_Activite_Physique_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showMessage('üìä Fichier Excel export√© avec succ√®s !', 'success');
        }

        function exportToCSV() {
            if (activityData.length === 0) {
                showMessage('‚ùå Aucune donn√©e √† exporter', 'danger');
                return;
            }

            let csv = 'Date,Nombre de pas,Objectif 7000+,Activit√© physique,Type,Lieu,Mois/Ann√©e\n';
            
            activityData.forEach(entry => {
                const date = new Date(entry.date);
                const monthYear = date.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
                csv += `${entry.date},${entry.steps},${(entry.steps >= 7000 || entry.activity) ? 'Oui' : 'Non'},${entry.activity ? 'Oui' : 'Non'},"${entry.activity || ''}","${entry.location || ''}",${monthYear}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `suivi_activite_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showMessage('üìã Fichier CSV export√© avec succ√®s !', 'success');
        }

        function switchToTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        function showMessage(text, type) {
            const messageArea = document.getElementById('messageArea');
            messageArea.innerHTML = `<div class="alert alert-${type}">${text}</div>`;
            setTimeout(() => {
                messageArea.innerHTML = '';
            }, 5000);
        }

        function updateAllDisplays() {
            updateOverviewStats();
            updateLocationStats();
            updateDataTable();
            updateMonthlyAnalysis();
            updateYearlyAnalysis();
            updateFinalAnalysis();
        }

        function updateOverviewStats() {
            const total = activityData.length;
            const over7000 = activityData.filter(entry => entry.steps >= 7000 || entry.activity).length;
            const withActivity = activityData.filter(entry => entry.activity).length;
            const enterprise = activityData.filter(entry => entry.location === 'Entreprise').length;
            const training = activityData.filter(entry => entry.location === 'Formation').length;
            const totalSteps = activityData.reduce((sum, entry) => sum + entry.steps, 0);
            const avgSteps = total > 0 ? Math.round(totalSteps / total) : 0;
            const maxSteps = total > 0 ? Math.max(...activityData.map(e => e.steps)) : 0;

            const userName = userProfile.firstName && userProfile.lastName ? 
                `${userProfile.firstName} ${userProfile.lastName}` : 'Utilisateur';

            document.getElementById('overviewStats').innerHTML = `
                <div class="stat-card">
                    <h3>üë§ Profil</h3>
                    <div class="stat-value" style="font-size: 1.5rem;">${userName}</div>
                    <p>D√©but: ${userProfile.startDate || 'Non d√©fini'}</p>
                </div>
                <div class="stat-card">
                    <h3>üìä Total entr√©es</h3>
                    <div class="stat-value">${total}</div>
                    <p>jours enregistr√©s</p>
                </div>
                <div class="stat-card">
                    <h3>üéØ Objectif 7000+ pas</h3>
                    <div class="stat-value">${over7000}</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${total > 0 ? (over7000/total)*100 : 0}%"></div>
                    </div>
                    <p>${total > 0 ? Math.round((over7000/total)*100) : 0}% des jours</p>
                    <small style="color: #666;">Incluant les activit√©s physiques</small>
                </div>
                <div class="stat-card">
                    <h3>üèÉ Activit√© physique</h3>
                    <div class="stat-value">${withActivity}</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${total > 0 ? (withActivity/total)*100 : 0}%"></div>
                    </div>
                    <p>${total > 0 ? Math.round((withActivity/total)*100) : 0}% des jours</p>
                </div>
                <div class="stat-card">
                    <h3>üè¢ Entreprise</h3>
                    <div class="stat-value">${enterprise}</div>
                    <p>jours en entreprise</p>
                </div>
                <div class="stat-card">
                    <h3>üéì Formation</h3>
                    <div class="stat-value">${training}</div>
                    <p>jours en formation</p>
                </div>
                <div class="stat-card">
                    <h3>üëü Moyenne pas/jour</h3>
                    <div class="stat-value">${avgSteps.toLocaleString()}</div>
                    <p>pas par jour</p>
                </div>
                <div class="stat-card">
                    <h3>üèÜ Record journalier</h3>
                    <div class="stat-value">${maxSteps.toLocaleString()}</div>
                    <p>pas maximum</p>
                </div>
            `;
        }

        function calculateLocationStats() {
            const stats = {
                enterprise: { total: 0, over7000: 0, avgSteps: 0, totalSteps: 0 },
                training: { total: 0, over7000: 0, avgSteps: 0, totalSteps: 0 },
                personal: { total: 0, over7000: 0, avgSteps: 0, totalSteps: 0 }
            };

            activityData.forEach(entry => {
                if (entry.location === 'Entreprise') {
                    stats.enterprise.total++;
                    stats.enterprise.totalSteps += entry.steps;
                    if (entry.steps >= 7000 || entry.activity) stats.enterprise.over7000++;
                } else if (entry.location === 'Formation') {
                    stats.training.total++;
                    stats.training.totalSteps += entry.steps;
                    if (entry.steps >= 7000 || entry.activity) stats.training.over7000++;
                } else if (entry.location === 'Personnel') {
                    stats.personal.total++;
                    stats.personal.totalSteps += entry.steps;
                    if (entry.steps >= 7000 || entry.activity) stats.personal.over7000++;
                }
            });

            stats.enterprise.avgSteps = stats.enterprise.total > 0 ? Math.round(stats.enterprise.totalSteps / stats.enterprise.total) : 0;
            stats.training.avgSteps = stats.training.total > 0 ? Math.round(stats.training.totalSteps / stats.training.total) : 0;
            stats.personal.avgSteps = stats.personal.total > 0 ? Math.round(stats.personal.totalSteps / stats.personal.total) : 0;

            return stats;
        }

        function updateLocationStats() {
            const stats = calculateLocationStats();
            
            if (activityData.length === 0) {
                document.getElementById('locationStats').innerHTML = '<p style="text-align: center; color: #666;">Pas de donn√©es disponibles</p>';
                return;
            }

            const enterpriseRate = stats.enterprise.total > 0 ? Math.round((stats.enterprise.over7000 / stats.enterprise.total) * 100) : 0;
            const trainingRate = stats.training.total > 0 ? Math.round((stats.training.over7000 / stats.training.total) * 100) : 0;
            const personalRate = stats.personal.total > 0 ? Math.round((stats.personal.over7000 / stats.personal.total) * 100) : 0;

            document.getElementById('locationStats').innerHTML = `
                <div class="location-stats-card">
                    <div class="location-stats-title">Objectif 7000+ pas atteint par lieu</div>
                    <div class="comparison-grid">
                        <div class="comparison-card enterprise">
                            <h3 style="color: #ff9800; font-size: 1.5rem; margin-bottom: 15px;">üè¢ Entreprise</h3>
                            <div style="font-size: 3rem; font-weight: bold; color: #ff9800; margin: 15px 0;">
                                ${stats.enterprise.over7000}
                            </div>
                            <div style="font-size: 1.2rem; color: #666; margin-bottom: 10px;">
                                sur ${stats.enterprise.total} jours
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${enterpriseRate}%; background: linear-gradient(135deg, #ff9800 0%, #ffa726 100%);"></div>
                            </div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #ff9800; margin-top: 10px;">
                                ${enterpriseRate}%
                            </div>
                            <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #eee;">
                                <strong>Moyenne pas/jour:</strong><br>
                                <span style="font-size: 1.3rem; color: #ff9800;">${stats.enterprise.avgSteps.toLocaleString()}</span>
                            </div>
                        </div>

                        <div class="comparison-card training">
                            <h3 style="color: #9c27b0; font-size: 1.5rem; margin-bottom: 15px;">üéì Formation</h3>
                            <div style="font-size: 3rem; font-weight: bold; color: #9c27b0; margin: 15px 0;">
                                ${stats.training.over7000}
                            </div>
                            <div style="font-size: 1.2rem; color: #666; margin-bottom: 10px;">
                                sur ${stats.training.total} jours
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${trainingRate}%; background: linear-gradient(135deg, #9c27b0 0%, #ba68c8 100%);"></div>
                            </div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #9c27b0; margin-top: 10px;">
                                ${trainingRate}%
                            </div>
                            <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #eee;">
                                <strong>Moyenne pas/jour:</strong><br>
                                <span style="font-size: 1.3rem; color: #9c27b0;">${stats.training.avgSteps.toLocaleString()}</span>
                            </div>
                        </div>

                        <div class="comparison-card personal">
                            <h3 style="color: #2196f3; font-size: 1.5rem; margin-bottom: 15px;">üè† Personnel</h3>
                            <div style="font-size: 3rem; font-weight: bold; color: #2196f3; margin: 15px 0;">
                                ${stats.personal.over7000}
                            </div>
                            <div style="font-size: 1.2rem; color: #666; margin-bottom: 10px;">
                                sur ${stats.personal.total} jours
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${personalRate}%; background: linear-gradient(135deg, #2196f3 0%, #42a5f5 100%);"></div>
                            </div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #2196f3; margin-top: 10px;">
                                ${personalRate}%
                            </div>
                            <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #eee;">
                                <strong>Moyenne pas/jour:</strong><br>
                                <span style="font-size: 1.3rem; color: #2196f3;">${stats.personal.avgSteps.toLocaleString()}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="location-stats-card">
                    <div class="location-stats-title">Analyse comparative</div>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <strong>Meilleur taux de r√©ussite</strong><br>
                            <div style="font-size: 1.5rem; color: #667eea; font-weight: bold; margin-top: 10px;">
                                ${getBestLocation(enterpriseRate, trainingRate, personalRate)}
                            </div>
                        </div>
                        <div class="summary-item">
                            <strong>Moyenne la plus √©lev√©e</strong><br>
                            <div style="font-size: 1.5rem; color: #667eea; font-weight: bold; margin-top: 10px;">
                                ${getHighestAverage(stats)}
                            </div>
                        </div>
                        <div class="summary-item">
                            <strong>Total objectifs atteints</strong><br>
                            <div style="font-size: 1.5rem; color: #667eea; font-weight: bold; margin-top: 10px;">
                                ${stats.enterprise.over7000 + stats.training.over7000 + stats.personal.over7000}
                            </div>
                        </div>
                        <div class="summary-item">
                            <strong>Total jours enregistr√©s</strong><br>
                            <div style="font-size: 1.5rem; color: #667eea; font-weight: bold; margin-top: 10px;">
                                ${stats.enterprise.total + stats.training.total + stats.personal.total}
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 20px; padding: 15px; background: white; border-radius: 8px;">
                        <strong>Observation:</strong><br>
                        ${generateLocationInsights(stats, enterpriseRate, trainingRate, personalRate)}
                    </div>
                </div>
            `;
        }

        function getBestLocation(enterpriseRate, trainingRate, personalRate) {
            const max = Math.max(enterpriseRate, trainingRate, personalRate);
            if (max === 0) return 'Aucune donn√©e';
            if (max === enterpriseRate) return 'Entreprise (' + enterpriseRate + '%)';
            if (max === trainingRate) return 'Formation (' + trainingRate + '%)';
            return 'Personnel (' + personalRate + '%)';
        }

        function getHighestAverage(stats) {
            const max = Math.max(stats.enterprise.avgSteps, stats.training.avgSteps, stats.personal.avgSteps);
            if (max === 0) return 'Aucune donn√©e';
            if (max === stats.enterprise.avgSteps) return 'Entreprise (' + max.toLocaleString() + ')';
            if (max === stats.training.avgSteps) return 'Formation (' + max.toLocaleString() + ')';
            return 'Personnel (' + max.toLocaleString() + ')';
        }

        function generateLocationInsights(stats, enterpriseRate, trainingRate, personalRate) {
            const insights = [];
            
            if (enterpriseRate > trainingRate && enterpriseRate > personalRate) {
                insights.push('Vous √™tes plus actif en entreprise. Votre lieu professionnel favorise votre activit√©.');
            } else if (trainingRate > enterpriseRate && trainingRate > personalRate) {
                insights.push('Les journ√©es en formation favorisent votre activit√© physique.');
            } else if (personalRate > enterpriseRate && personalRate > trainingRate) {
                insights.push('Vos journ√©es personnelles sont les plus actives.');
            }

            if (enterpriseRate < 50 && stats.enterprise.total > 5) {
                insights.push('Pensez √† bouger davantage pendant vos journ√©es en entreprise.');
            }

            const diff = Math.max(enterpriseRate, trainingRate, personalRate) - Math.min(enterpriseRate, trainingRate, personalRate);
            if (diff > 30) {
                insights.push('Il existe un √©cart important entre vos diff√©rents contextes.');
            }

            return insights.length > 0 ? insights.join(' ') : 'Continuez votre suivi r√©gulier pour obtenir plus d\'analyses.';
        }

        function updateDataTable() {
            const tbody = document.getElementById('dataTable');
            tbody.innerHTML = '';

            if (activityData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="padding: 40px; color: #666;">Aucune donn√©e disponible. Ajoutez votre premi√®re entr√©e !</td></tr>';
                return;
            }

            activityData.forEach(entry => {
                const date = new Date(entry.date);
                const monthYear = date.toLocaleDateString('fr-FR', { month: 'short', year: 'numeric' });
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${entry.date}</td>
                    <td><span class="${entry.steps >= 7000 ? 'steps-high' : 'steps-low'}">${entry.steps.toLocaleString()}</span></td>
                    <td><span class="${entry.steps >= 7000 || entry.activity ? 'steps-high' : 'steps-low'}">${entry.steps >= 7000 || entry.activity ? 'Oui' : 'Non'}</span></td>
                    <td><span class="${entry.activity ? 'activity-yes' : ''}">${entry.activity ? 'Oui' : 'Non'}</span></td>
                    <td><span class="${entry.activity ? 'activity-yes' : ''}">${entry.activity || '-'}</span></td>
                    <td><span class="${getLocationClass(entry.location)}">${entry.location || '-'}</span></td>
                    <td>${monthYear}</td>
                    <td>
                        <button class="btn btn-info" onclick="editEntry('${entry.date}')" style="padding: 5px 10px; font-size: 12px; margin: 2px;">Modifier</button>
                        <button class="btn btn-danger" onclick="deleteEntry('${entry.date}')" style="padding: 5px 10px; font-size: 12px; margin: 2px;">Supprimer</button>
                    </td>
                `;
            });
        }

        function getLocationClass(location) {
            switch(location) {
                case 'Entreprise': return 'location-enterprise';
                case 'Formation': return 'location-training';
                default: return '';
            }
        }

        function updateMonthlyAnalysis() {
            const monthlyData = {};
            
            activityData.forEach(entry => {
                const date = new Date(entry.date);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                const monthLabel = date.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
                
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = {
                        label: monthLabel,
                        totalDays: 0,
                        daysOver7000: 0,
                        daysWithActivity: 0,
                        daysAtEnterprise: 0,
                        daysAtTraining: 0,
                        totalSteps: 0
                    };
                }
                
                const month = monthlyData[monthKey];
                month.totalDays++;
                month.totalSteps += entry.steps;
                if (entry.steps >= 7000 || entry.activity) month.daysOver7000++;
                if (entry.activity) month.daysWithActivity++;
                if (entry.location === 'Entreprise') month.daysAtEnterprise++;
                if (entry.location === 'Formation') month.daysAtTraining++;
            });

            const sortedMonths = Object.keys(monthlyData).sort();
            
            if (sortedMonths.length === 0) {
                document.getElementById('monthlyContent').innerHTML = '<p style="text-align: center; color: #666;">Pas de donn√©es disponibles pour l\'analyse mensuelle</p>';
                return;
            }

            let content = '';
            let previousMonth = null;
            const today = new Date();
            const currentMonthKey = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;

            sortedMonths.forEach(monthKey => {
                const month = monthlyData[monthKey];
                month.avgSteps = Math.round(month.totalSteps / month.totalDays);
                month.successRate = Math.round((month.daysOver7000 / month.totalDays) * 100);
                
                const isCurrentMonth = monthKey === currentMonthKey;
                
                let evolution = '';
                if (previousMonth) {
                    const prevDays = previousMonth.daysOver7000;
                    const currDays = month.daysOver7000;
                    if (currDays > prevDays) {
                        evolution = `<span style="background: #e8f5e8; color: #2e7d32; padding: 5px 10px; border-radius: 15px; font-weight: bold;">+${currDays - prevDays}</span>`;
                    } else if (currDays < prevDays) {
                        evolution = `<span style="background: #ffebee; color: #c62828; padding: 5px 10px; border-radius: 15px; font-weight: bold;">${currDays - prevDays}</span>`;
                    } else {
                        evolution = '<span style="background: #fff3e0; color: #ef6c00; padding: 5px 10px; border-radius: 15px; font-weight: bold;">=</span>';
                    }
                }
                
                content += `
                    <div class="summary-section">
                        <div class="summary-title">
                            ${month.label} 
                            ${evolution}
                            ${isCurrentMonth ? '<span style="background: #4caf50; color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.85rem; margin-left: 10px;">En cours</span>' : ''}
                        </div>
                        <div class="summary-grid">
                            <div class="summary-item">
                                <strong>Total jours</strong><br>
                                <div style="font-size: 1.5rem; color: #667eea; font-weight: bold;">${month.totalDays}</div>
                                ${isCurrentMonth ? '<small style="color: #666;">Mois en cours</small>' : ''}
                            </div>
                            <div class="summary-item">
                                <strong>Objectif atteint</strong><br>
                                <div style="font-size: 1.5rem; color: #667eea; font-weight: bold;">${month.daysOver7000}/${month.totalDays}</div>
                                <div class="progress-bar" style="margin-top: 5px;">
                                    <div class="progress-fill" style="width: ${month.successRate}%"></div>
                                </div>
                                <small>${month.successRate}%</small>
                            </div>
                            <div class="summary-item">
                                <strong>Activit√© physique</strong><br>
                                <div style="font-size: 1.5rem; color: #667eea; font-weight: bold;">${month.daysWithActivity}</div>
                                <small>${month.totalDays > 0 ? Math.round((month.daysWithActivity / month.totalDays) * 100) : 0}% des jours</small>
                            </div>
                            <div class="summary-item">
                                <strong>Entreprise</strong><br>
                                <div style="font-size: 1.5rem; color: #667eea; font-weight: bold;">${month.daysAtEnterprise}</div>
                            </div>
                            <div class="summary-item">
                                <strong>Formation</strong><br>
                                <div style="font-size: 1.5rem; color: #667eea; font-weight: bold;">${month.daysAtTraining}</div>
                            </div>
                            <div class="summary-item">
                                <strong>Moyenne pas/jour</strong><br>
                                <div style="font-size: 1.5rem; color: #667eea; font-weight: bold;">${month.avgSteps.toLocaleString()}</div>
                            </div>
                        </div>
                    </div>
                `;
                
                previousMonth = month;
            });

            document.getElementById('monthlyContent').innerHTML = content;
        }

        function updateYearlyAnalysis() {
            const yearlyData = {};
            
            activityData.forEach(entry => {
                const year = new Date(entry.date).getFullYear();
                
                if (!yearlyData[year]) {
                    yearlyData[year] = {
                        year: year,
                        totalDays: 0,
                        daysOver7000: 0,
                        daysWithActivity: 0,
                        daysAtEnterprise: 0,
                        daysAtTraining: 0,
                        totalSteps: 0,
                        activities: {}
                    };
                }
                
                const yearData = yearlyData[year];
                yearData.totalDays++;
                yearData.totalSteps += entry.steps;
                if (entry.steps >= 7000 || entry.activity) yearData.daysOver7000++;
                if (entry.activity) {
                    yearData.daysWithActivity++;
                    yearData.activities[entry.activity] = (yearData.activities[entry.activity] || 0) + 1;
                }
                if (entry.location === 'Entreprise') yearData.daysAtEnterprise++;
                if (entry.location === 'Formation') yearData.daysAtTraining++;
            });

            const sortedYears = Object.keys(yearlyData).sort();
            
            if (sortedYears.length === 0) {
                document.getElementById('yearlyContent').innerHTML = '<p style="text-align: center; color: #666;">Pas de donn√©es disponibles pour l\'analyse annuelle</p>';
                return;
            }

            let content = '';
            const currentYear = new Date().getFullYear();

            sortedYears.forEach(year => {
                const data = yearlyData[year];
                data.avgSteps = Math.round(data.totalSteps / data.totalDays);
                data.successRate = Math.round((data.daysOver7000 / data.totalDays) * 100);
                data.activityRate = Math.round((data.daysWithActivity / data.totalDays) * 100);
                
                const isCurrentYear = parseInt(year) === currentYear;
                
                const activitiesList = Object.entries(data.activities)
                    .sort((a, b) => b[1] - a[1])
                    .map(([activity, count]) => `${activity} (${count}x)`)
                    .join(', ');
                
                content += `
                    <div class="summary-section">
                        <div class="summary-title">
                            Ann√©e ${data.year}
                            ${isCurrentYear ? '<span style="background: #4caf50; color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.85rem; margin-left: 10px;">En cours</span>' : ''}
                        </div>
                        <div class="summary-grid">
                            <div class="summary-item">
                                <strong>Total jours</strong><br>
                                <div style="font-size: 2rem; color: #667eea; font-weight: bold;">${data.totalDays}</div>
                                ${isCurrentYear ? '<small style="color: #666;">Ann√©e en cours</small>' : ''}
                            </div>
                            <div class="summary-item">
                                <strong>Taux de r√©ussite</strong><br>
                                <div style="font-size: 2rem; color: #667eea; font-weight: bold;">${data.successRate}%</div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${data.successRate}%"></div>
                                </div>
                                <small>${data.daysOver7000}/${data.totalDays} jours</small>
                            </div>
                            <div class="summary-item">
                                <strong>Activit√© physique</strong><br>
                                <div style="font-size: 2rem; color: #667eea; font-weight: bold;">${data.activityRate}%</div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${data.activityRate}%; background: linear-gradient(135deg, #2196f3 0%, #42a5f5 100%);"></div>
                                </div>
                                <small>${data.daysWithActivity} jours</small>
                            </div>
                            <div class="summary-item">
                                <strong>Entreprise</strong><br>
                                <div style="font-size: 2rem; color: #667eea; font-weight: bold;">${data.daysAtEnterprise}</div>
                                <small>jours</small>
                            </div>
                            <div class="summary-item">
                                <strong>Formation</strong><br>
                                <div style="font-size: 2rem; color: #667eea; font-weight: bold;">${data.daysAtTraining}</div>
                                <small>jours</small>
                            </div>
                            <div class="summary-item">
                                <strong>Personnel</strong><br>
                                <div style="font-size: 2rem; color: #667eea; font-weight: bold;">${data.totalDays - data.daysAtEnterprise - data.daysAtTraining}</div>
                                <small>jours</small>
                            </div>
                            <div class="summary-item">
                                <strong>Moyenne pas/jour</strong><br>
                                <div style="font-size: 1.5rem; color: #667eea; font-weight: bold;">${data.avgSteps.toLocaleString()}</div>
                            </div>
                            <div class="summary-item">
                                <strong>Total de pas</strong><br>
                                <div style="font-size: 1.5rem; color: #667eea; font-weight: bold;">${data.totalSteps.toLocaleString()}</div>
                            </div>
                        </div>
                        ${activitiesList ? `
                            <div style="margin-top: 20px; padding: 15px; background: white; border-radius: 8px;">
                                <strong>Activit√©s pratiqu√©es :</strong><br>
                                ${activitiesList}
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            // Comparaison entre ann√©es si plusieurs ann√©es disponibles
            if (sortedYears.length > 1) {
                const firstYear = yearlyData[sortedYears[0]];
                const lastYear = yearlyData[sortedYears[sortedYears.length - 1]];
                
                const successDiff = lastYear.successRate - firstYear.successRate;
                const avgStepsDiff = lastYear.avgSteps - firstYear.avgSteps;
                
                content += `
                    <div class="summary-section" style="background: linear-gradient(135deg, #f8f9fa 0%, #e3f2fd 100%);">
                        <div class="summary-title">√âvolution entre ${firstYear.year} et ${lastYear.year}</div>
                        <div class="summary-grid">
                            <div class="summary-item">
                                <strong>Taux de r√©ussite</strong><br>
                                <div style="font-size: 2rem; color: ${successDiff >= 0 ? '#4caf50' : '#f44336'}; font-weight: bold;">
                                    ${successDiff >= 0 ? '+' : ''}${successDiff}%
                                </div>
                                <small>${firstYear.successRate}% ‚Üí ${lastYear.successRate}%</small>
                            </div>
                            <div class="summary-item">
                                <strong>Moyenne pas/jour</strong><br>
                                <div style="font-size: 2rem; color: ${avgStepsDiff >= 0 ? '#4caf50' : '#f44336'}; font-weight: bold;">
                                    ${avgStepsDiff >= 0 ? '+' : ''}${avgStepsDiff.toLocaleString()}
                                </div>
                                <small>${firstYear.avgSteps.toLocaleString()} ‚Üí ${lastYear.avgSteps.toLocaleString()}</small>
                            </div>
                            <div class="summary-item">
                                <strong>Total jours suivis</strong><br>
                                <div style="font-size: 2rem; color: #667eea; font-weight: bold;">
                                    ${Object.values(yearlyData).reduce((sum, y) => sum + y.totalDays, 0)}
                                </div>
                                <small>Sur ${sortedYears.length} ann√©e(s)</small>
                            </div>
                        </div>
                    </div>
                `;
            }

            document.getElementById('yearlyContent').innerHTML = content;
        }

        function updateFinalAnalysis() {
            if (activityData.length === 0) {
                document.getElementById('finalContent').innerHTML = '<p style="text-align: center; color: #666;">Pas de donn√©es disponibles</p>';
                return;
            }

            const total = activityData.length;
            const over7000 = activityData.filter(entry => entry.steps >= 7000 || entry.activity).length;
            const successRate = Math.round((over7000 / total) * 100);

            document.getElementById('finalContent').innerHTML = `
                <div class="summary-section">
                    <div class="summary-title">Bilan sur 2 ann√©es</div>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <strong>Dur√©e du suivi</strong><br>
                            <div style="font-size: 2.5rem; color: #667eea; font-weight: bold;">${total}</div>
                            <p>jours enregistr√©s</p>
                        </div>
                        <div class="summary-item">
                            <strong>Taux de r√©ussite global</strong><br>
                            <div style="font-size: 2.5rem; color: #667eea; font-weight: bold;">${successRate}%</div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${successRate}%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>